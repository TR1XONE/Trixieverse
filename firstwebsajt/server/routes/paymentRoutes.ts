/**\n * Payment API Routes\n */\n\nimport { Router, Request, Response } from 'express';\nimport Stripe from 'stripe';\nimport paymentService from '../services/paymentService';\nimport authMiddleware from '../middleware/authMiddleware';\nimport logger from '../utils/logger';\n\nconst router = Router();\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY || '');\n\n/**\n * GET /payment/plans\n * Get available subscription plans\n */\nrouter.get('/plans', (req: Request, res: Response) => {\n  try {\n    const plans = paymentService.getSubscriptionPlans();\n    res.json(plans);\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to get plans' });\n  }\n});\n\n/**\n * POST /payment/checkout\n * Create checkout session\n */\nrouter.post('/checkout', authMiddleware, async (req: Request, res: Response) => {\n  try {\n    const userId = req.user?.id;\n    const { planId } = req.body;\n\n    if (!userId || !planId) {\n      return res.status(400).json({ error: 'Missing required fields' });\n    }\n\n    const successUrl = `${process.env.FRONTEND_URL}/subscription/success`;\n    const cancelUrl = `${process.env.FRONTEND_URL}/subscription/cancel`;\n\n    const checkoutUrl = await paymentService.createCheckoutSession(\n      userId,\n      planId,\n      successUrl,\n      cancelUrl\n    );\n\n    if (!checkoutUrl) {\n      return res.status(500).json({ error: 'Failed to create checkout session' });\n    }\n\n    res.json({ url: checkoutUrl });\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to create checkout session' });\n  }\n});\n\n/**\n * GET /payment/subscription\n * Get user subscription\n */\nrouter.get('/subscription', authMiddleware, async (req: Request, res: Response) => {\n  try {\n    const userId = req.user?.id;\n    if (!userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    const subscription = await paymentService.getUserSubscription(userId);\n    res.json(subscription || { plan: null, status: 'free' });\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to get subscription' });\n  }\n});\n\n/**\n * POST /payment/cancel\n * Cancel subscription\n */\nrouter.post('/cancel', authMiddleware, async (req: Request, res: Response) => {\n  try {\n    const userId = req.user?.id;\n    if (!userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    const success = await paymentService.cancelSubscription(userId);\n    if (!success) {\n      return res.status(500).json({ error: 'Failed to cancel subscription' });\n    }\n\n    res.json({ success: true });\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to cancel subscription' });\n  }\n});\n\n/**\n * POST /payment/webhook\n * Handle Stripe webhooks\n */\nrouter.post('/webhook', async (req: Request, res: Response) => {\n  const sig = req.headers['stripe-signature'] as string;\n  const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;\n\n  if (!webhookSecret) {\n    return res.status(400).json({ error: 'Webhook secret not configured' });\n  }\n\n  try {\n    const event = stripe.webhooks.constructEvent(\n      req.body,\n      sig,\n      webhookSecret\n    );\n\n    await paymentService.handleWebhookEvent(event);\n    res.json({ received: true });\n  } catch (error) {\n    logger.error({ message: 'Webhook signature verification failed', error });\n    res.status(400).json({ error: 'Webhook signature verification failed' });\n  }\n});\n\nexport default router;\n

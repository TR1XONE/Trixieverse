/**\n * Marketing & Growth Tools Service\n * Viral loops, referrals, and growth hacking\n */\n\nimport db from '../database/connection';\nimport logger from '../utils/logger';\nimport emailService from './emailService.js';\nimport crypto from 'crypto';\n\ninterface ReferralCode {\n  code: string;\n  userId: string;\n  createdAt: Date;\n  expiresAt: Date;\n  usedCount: number;\n  reward: number;\n}\n\ninterface ViralLoop {\n  type: 'achievement_share' | 'rank_up_share' | 'coach_reaction' | 'leaderboard_challenge';\n  userId: string;\n  data: any;\n  shareUrl: string;\n  expiresAt: Date;\n}\n\nclass MarketingGrowthService {\n  /**\n   * Generate referral code\n   */\n  async generateReferralCode(userId: string): Promise<ReferralCode | null> {\n    try {\n      const code = crypto.randomBytes(6).toString('hex').toUpperCase();\n      const expiresAt = new Date(Date.now() + 90 * 24 * 60 * 60 * 1000); // 90 days\n\n      await db.query(\n        `INSERT INTO referral_codes (code, user_id, expires_at, reward)\n         VALUES ($1, $2, $3, $4)`,\n        [code, userId, expiresAt, 500] // 500 XP reward\n      );\n\n      logger.info(`Referral code generated: ${code}`);\n\n      return {\n        code,\n        userId,\n        createdAt: new Date(),\n        expiresAt,\n        usedCount: 0,\n        reward: 500,\n      };\n    } catch (error) {\n      logger.error({ message: 'Failed to generate referral code', error });\n      return null;\n    }\n  }\n\n  /**\n   * Use referral code\n   */\n  async useReferralCode(code: string, newUserId: string): Promise<boolean> {\n    try {\n      // Get referral code\n      const result = await db.query(\n        'SELECT user_id, reward FROM referral_codes WHERE code = $1 AND expires_at > NOW()',\n        [code]\n      );\n\n      if (result.rows.length === 0) {\n        return false; // Code not found or expired\n      }\n\n      const { user_id: referrerId, reward } = result.rows[0];\n\n      // Check if already used by this user\n      const used = await db.query(\n        'SELECT id FROM referral_uses WHERE code = $1 AND user_id = $2',\n        [code, newUserId]\n      );\n\n      if (used.rows.length > 0) {\n        return false; // Already used\n      }\n\n      // Record referral use\n      await db.query(\n        `INSERT INTO referral_uses (code, user_id, referrer_id)\n         VALUES ($1, $2, $3)`,\n        [code, newUserId, referrerId]\n      );\n\n      // Give reward to referrer\n      await db.query(\n        `UPDATE leaderboard_entries SET xp = xp + $1 WHERE user_id = $2`,\n        [reward, referrerId]\n      );\n\n      // Give bonus to new user\n      await db.query(\n        `UPDATE leaderboard_entries SET xp = xp + $1 WHERE user_id = $2`,\n        [reward / 2, newUserId]\n      );\n\n      logger.info(`Referral code used: ${code} by ${newUserId}`);\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to use referral code', error });\n      return false;\n    }\n  }\n\n  /**\n   * Create viral loop for achievement\n   */\n  async createAchievementViralLoop(userId: string, achievement: any): Promise<ViralLoop | null> {\n    try {\n      const shareUrl = `https://trixieverse.com/share/achievement/${crypto.randomBytes(8).toString('hex')}`;\n      const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7 days\n\n      await db.query(\n        `INSERT INTO viral_loops (type, user_id, data, share_url, expires_at)\n         VALUES ($1, $2, $3, $4, $5)`,\n        ['achievement_share', userId, JSON.stringify(achievement), shareUrl, expiresAt]\n      );\n\n      return {\n        type: 'achievement_share',\n        userId,\n        data: achievement,\n        shareUrl,\n        expiresAt,\n      };\n    } catch (error) {\n      logger.error({ message: 'Failed to create achievement viral loop', error });\n      return null;\n    }\n  }\n\n  /**\n   * Create viral loop for rank up\n   */\n  async createRankUpViralLoop(userId: string, newRank: string): Promise<ViralLoop | null> {\n    try {\n      const shareUrl = `https://trixieverse.com/share/rankup/${crypto.randomBytes(8).toString('hex')}`;\n      const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);\n\n      await db.query(\n        `INSERT INTO viral_loops (type, user_id, data, share_url, expires_at)\n         VALUES ($1, $2, $3, $4, $5)`,\n        ['rank_up_share', userId, JSON.stringify({ newRank }), shareUrl, expiresAt]\n      );\n\n      return {\n        type: 'rank_up_share',\n        userId,\n        data: { newRank },\n        shareUrl,\n        expiresAt,\n      };\n    } catch (error) {\n      logger.error({ message: 'Failed to create rank up viral loop', error });\n      return null;\n    }\n  }\n\n  /**\n   * Create leaderboard challenge\n   */\n  async createLeaderboardChallenge(userId: string, challengeData: any): Promise<string | null> {\n    try {\n      const challengeId = crypto.randomBytes(8).toString('hex');\n      const shareUrl = `https://trixieverse.com/challenge/${challengeId}`;\n      const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);\n\n      await db.query(\n        `INSERT INTO challenges (challenge_id, user_id, data, share_url, expires_at)\n         VALUES ($1, $2, $3, $4, $5)`,\n        [challengeId, userId, JSON.stringify(challengeData), shareUrl, expiresAt]\n      );\n\n      logger.info(`Challenge created: ${challengeId}`);\n      return shareUrl;\n    } catch (error) {\n      logger.error({ message: 'Failed to create challenge', error });\n      return null;\n    }\n  }\n\n  /**\n   * Get growth metrics\n   */\n  async getGrowthMetrics(): Promise<any> {\n    try {\n      const result = await db.query(\n        `SELECT \n           COUNT(DISTINCT u.id) as total_users,\n           COUNT(DISTINCT CASE WHEN u.created_at > NOW() - INTERVAL '7 days' THEN u.id END) as new_users_7d,\n           COUNT(DISTINCT CASE WHEN u.created_at > NOW() - INTERVAL '30 days' THEN u.id END) as new_users_30d,\n           COUNT(DISTINCT CASE WHEN u.last_login > NOW() - INTERVAL '1 day' THEN u.id END) as dau,\n           COUNT(DISTINCT CASE WHEN u.last_login > NOW() - INTERVAL '7 days' THEN u.id END) as wau,\n           COUNT(DISTINCT CASE WHEN u.last_login > NOW() - INTERVAL '30 days' THEN u.id END) as mau,\n           (SELECT COUNT(*) FROM referral_uses) as total_referrals,\n           (SELECT COUNT(*) FROM viral_loops WHERE created_at > NOW() - INTERVAL '7 days') as viral_loops_7d\n         FROM users u`\n      );\n\n      const metrics = result.rows[0];\n      return {\n        ...metrics,\n        dau_wau_ratio: (metrics.dau / metrics.wau * 100).toFixed(1),\n        wau_mau_ratio: (metrics.wau / metrics.mau * 100).toFixed(1),\n        growth_rate_7d: ((metrics.new_users_7d / metrics.total_users) * 100).toFixed(1),\n        growth_rate_30d: ((metrics.new_users_30d / metrics.total_users) * 100).toFixed(1),\n      };\n    } catch (error) {\n      logger.error({ message: 'Failed to get growth metrics', error });\n      return null;\n    }\n  }\n\n  /**\n   * Send viral email\n   */\n  async sendViralEmail(userId: string, type: 'referral' | 'achievement' | 'rank_up'): Promise<boolean> {\n    try {\n      const user = await db.query('SELECT email, username FROM users WHERE id = $1', [userId]);\n      if (user.rows.length === 0) return false;\n\n      const { email, username } = user.rows[0];\n\n      if (type === 'referral') {\n        const referralCode = await this.generateReferralCode(userId);\n        if (!referralCode) return false;\n\n        await emailService.sendReferralEmail(email, username, referralCode.code);\n      } else if (type === 'achievement') {\n        // Send achievement share email\n        await emailService.sendAchievementEmail(email, username, 'Check out my achievement!');\n      } else if (type === 'rank_up') {\n        // Send rank up share email\n        await emailService.sendRankUpEmail(email, username, 'GOLD');\n      }\n\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to send viral email', error });\n      return false;\n    }\n  }\n\n  /**\n   * Get referral stats\n   */\n  async getReferralStats(userId: string): Promise<any> {\n    try {\n      const result = await db.query(\n        `SELECT \n           COUNT(*) as total_referrals,\n           SUM(CASE WHEN created_at > NOW() - INTERVAL '7 days' THEN 1 ELSE 0 END) as referrals_7d,\n           SUM(CASE WHEN created_at > NOW() - INTERVAL '30 days' THEN 1 ELSE 0 END) as referrals_30d\n         FROM referral_uses\n         WHERE referrer_id = $1`,\n        [userId]\n      );\n\n      return result.rows[0];\n    } catch (error) {\n      logger.error({ message: 'Failed to get referral stats', error });\n      return null;\n    }\n  }\n}\n\nexport default new MarketingGrowthService();\n

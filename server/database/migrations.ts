/**\n * Database Migrations\n * Manage database schema changes\n */\n\nimport db from './connection.js';\nimport logger from '../utils/logger.js';\nimport fs from 'fs';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\ninterface Migration {\n  name: string;\n  up: () => Promise<void>;\n  down: () => Promise<void>;\n}\n\nclass MigrationManager {\n  private migrationsDir = path.join(__dirname, 'migrations');\n\n  /**\n   * Initialize migrations table\n   */\n  async initializeMigrationsTable(): Promise<void> {\n    try {\n      await db.query(`\n        CREATE TABLE IF NOT EXISTS migrations (\n          id SERIAL PRIMARY KEY,\n          name VARCHAR(255) UNIQUE NOT NULL,\n          executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )\n      `);\n      logger.info('Migrations table initialized');\n    } catch (error) {\n      logger.error({ message: 'Failed to initialize migrations table', error });\n      throw error;\n    }\n  }\n\n  /**\n   * Get executed migrations\n   */\n  async getExecutedMigrations(): Promise<string[]> {\n    try {\n      const result = await db.query('SELECT name FROM migrations ORDER BY executed_at');\n      return result.rows.map((row) => row.name);\n    } catch (error) {\n      logger.error({ message: 'Failed to get executed migrations', error });\n      return [];\n    }\n  }\n\n  /**\n   * Get pending migrations\n   */\n  async getPendingMigrations(): Promise<string[]> {\n    try {\n      const executedMigrations = await this.getExecutedMigrations();\n      const files = fs.readdirSync(this.migrationsDir).filter((f) => f.endsWith('.ts'));\n      return files.filter((f) => !executedMigrations.includes(f.replace('.ts', '')));\n    } catch (error) {\n      logger.error({ message: 'Failed to get pending migrations', error });\n      return [];\n    }\n  }\n\n  /**\n   * Run migrations\n   */\n  async runMigrations(): Promise<void> {\n    try {\n      await this.initializeMigrationsTable();\n\n      const pendingMigrations = await this.getPendingMigrations();\n\n      if (pendingMigrations.length === 0) {\n        logger.info('No pending migrations');\n        return;\n      }\n\n      logger.info(`Running ${pendingMigrations.length} pending migrations`);\n\n      for (const migrationFile of pendingMigrations) {\n        const migrationName = migrationFile.replace('.ts', '');\n        try {\n          logger.info(`Running migration: ${migrationName}`);\n\n          // Dynamic import\n          const migration = await import(path.join(this.migrationsDir, migrationFile));\n          await migration.default.up();\n\n          // Record migration\n          await db.query('INSERT INTO migrations (name) VALUES ($1)', [migrationName]);\n\n          logger.info(`Migration completed: ${migrationName}`);\n        } catch (error) {\n          logger.error({ message: `Migration failed: ${migrationName}`, error });\n          throw error;\n        }\n      }\n\n      logger.info('All migrations completed successfully');\n    } catch (error) {\n      logger.error({ message: 'Failed to run migrations', error });\n      throw error;\n    }\n  }\n\n  /**\n   * Rollback last migration\n   */\n  async rollbackLastMigration(): Promise<void> {\n    try {\n      const executedMigrations = await this.getExecutedMigrations();\n\n      if (executedMigrations.length === 0) {\n        logger.info('No migrations to rollback');\n        return;\n      }\n\n      const lastMigration = executedMigrations[executedMigrations.length - 1];\n      const migrationFile = `${lastMigration}.ts`;\n\n      logger.info(`Rolling back migration: ${lastMigration}`);\n\n      // Dynamic import\n      const migration = await import(path.join(this.migrationsDir, migrationFile));\n      await migration.default.down();\n\n      // Remove migration record\n      await db.query('DELETE FROM migrations WHERE name = $1', [lastMigration]);\n\n      logger.info(`Migration rolled back: ${lastMigration}`);\n    } catch (error) {\n      logger.error({ message: 'Failed to rollback migration', error });\n      throw error;\n    }\n  }\n\n  /**\n   * Get migration status\n   */\n  async getMigrationStatus(): Promise<any> {\n    try {\n      const executedMigrations = await this.getExecutedMigrations();\n      const pendingMigrations = await this.getPendingMigrations();\n\n      return {\n        executed: executedMigrations,\n        pending: pendingMigrations,\n        total: executedMigrations.length + pendingMigrations.length,\n      };\n    } catch (error) {\n      logger.error({ message: 'Failed to get migration status', error });\n      return null;\n    }\n  }\n}\n\nexport default new MigrationManager();\n

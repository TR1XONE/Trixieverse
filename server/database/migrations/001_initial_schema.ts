/**\n * Initial Database Schema Migration\n */\n\nimport db from '../connection.js';\n\nconst migration = {\n  async up() {\n    // Users table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS users (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        email VARCHAR(255) UNIQUE NOT NULL,\n        username VARCHAR(255) UNIQUE NOT NULL,\n        password_hash VARCHAR(255) NOT NULL,\n        avatar_url TEXT,\n        bio TEXT,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        last_login TIMESTAMP,\n        is_active BOOLEAN DEFAULT true,\n        subscription_plan VARCHAR(50),\n        subscription_status VARCHAR(50),\n        subscription_started_at TIMESTAMP,\n        subscription_ended_at TIMESTAMP,\n        stripe_customer_id VARCHAR(255),\n        stripe_subscription_id VARCHAR(255),\n        role VARCHAR(50) DEFAULT 'user'\n      )\n    `);\n\n    // Player accounts table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS player_accounts (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        game_name VARCHAR(255) NOT NULL,\n        tag VARCHAR(10) NOT NULL,\n        region VARCHAR(10),\n        current_rank VARCHAR(50),\n        main_role VARCHAR(50),\n        champion_pool TEXT,\n        riot_puuid VARCHAR(255),\n        connected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        UNIQUE(user_id, game_name, tag)\n      )\n    `);\n\n    // Coach personalities table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS coach_personalities (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        personality_type VARCHAR(50) NOT NULL,\n        accent VARCHAR(50),\n        response_style VARCHAR(50),\n        message_length VARCHAR(50),\n        celebration_level INTEGER,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n\n    // Coach memories table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS coach_memories (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        memory_type VARCHAR(50) NOT NULL,\n        content TEXT NOT NULL,\n        emotional_weight INTEGER,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        INDEX idx_user_memory (user_id, created_at)\n      )\n    `);\n\n    // Matches table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS matches (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        player_account_id UUID REFERENCES player_accounts(id) ON DELETE CASCADE,\n        champion VARCHAR(50),\n        role VARCHAR(50),\n        result VARCHAR(10),\n        duration INTEGER,\n        kills INTEGER,\n        deaths INTEGER,\n        assists INTEGER,\n        cs_per_minute DECIMAL(5, 2),\n        gold_earned INTEGER,\n        damage_dealt INTEGER,\n        damage_taken INTEGER,\n        analysis_data JSONB,\n        performance_score DECIMAL(5, 2),\n        match_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n\n    // Achievements table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS achievements (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        achievement_key VARCHAR(100) NOT NULL,\n        title VARCHAR(255) NOT NULL,\n        description TEXT,\n        rarity VARCHAR(50),\n        icon_url TEXT,\n        unlocked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        UNIQUE(user_id, achievement_key)\n      )\n    `);\n\n    // Skill profiles table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS skill_profiles (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        player_account_id UUID REFERENCES player_accounts(id) ON DELETE CASCADE,\n        mechanics_score DECIMAL(5, 2),\n        macro_play_score DECIMAL(5, 2),\n        decision_making_score DECIMAL(5, 2),\n        consistency_score DECIMAL(5, 2),\n        clutch_factor_score DECIMAL(5, 2),\n        overall_rating DECIMAL(5, 2),\n        trend VARCHAR(50),\n        matches_analyzed INTEGER DEFAULT 0,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n\n    // Leaderboard entries table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS leaderboard_entries (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        rank INTEGER,\n        xp INTEGER DEFAULT 0,\n        level INTEGER DEFAULT 1,\n        win_rate DECIMAL(5, 2),\n        matches_played INTEGER DEFAULT 0,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n\n    // Friends table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS friends (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        friend_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        UNIQUE(user_id, friend_id)\n      )\n    `);\n\n    // Coaching circles table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS coaching_circles (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        name VARCHAR(255) NOT NULL,\n        description TEXT,\n        created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        is_public BOOLEAN DEFAULT false,\n        member_count INTEGER DEFAULT 1,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n\n    // Circle members table\n    await db.query(`\n      CREATE TABLE IF NOT EXISTS circle_members (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        circle_id UUID NOT NULL REFERENCES coaching_circles(id) ON DELETE CASCADE,\n        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n        joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        UNIQUE(circle_id, user_id)\n      )\n    `);\n\n    // Create indexes\n    await db.query('CREATE INDEX idx_users_email ON users(email)');\n    await db.query('CREATE INDEX idx_player_accounts_user_id ON player_accounts(user_id)');\n    await db.query('CREATE INDEX idx_matches_user_id ON matches(user_id)');\n    await db.query('CREATE INDEX idx_matches_timestamp ON matches(match_timestamp)');\n    await db.query('CREATE INDEX idx_achievements_user_id ON achievements(user_id)');\n    await db.query('CREATE INDEX idx_skill_profiles_user_id ON skill_profiles(user_id)');\n    await db.query('CREATE INDEX idx_leaderboard_rank ON leaderboard_entries(rank)');\n  },\n\n  async down() {\n    // Drop tables in reverse order\n    await db.query('DROP TABLE IF EXISTS circle_members');\n    await db.query('DROP TABLE IF EXISTS coaching_circles');\n    await db.query('DROP TABLE IF EXISTS friends');\n    await db.query('DROP TABLE IF EXISTS leaderboard_entries');\n    await db.query('DROP TABLE IF EXISTS skill_profiles');\n    await db.query('DROP TABLE IF EXISTS achievements');\n    await db.query('DROP TABLE IF EXISTS matches');\n    await db.query('DROP TABLE IF EXISTS coach_memories');\n    await db.query('DROP TABLE IF EXISTS coach_personalities');\n    await db.query('DROP TABLE IF EXISTS player_accounts');\n    await db.query('DROP TABLE IF EXISTS users');\n  },\n};\n\nexport default migration;\n

/**\n * Payment Service\n * Handles Stripe payments and subscriptions\n */\n\nimport Stripe from 'stripe';\nimport db from '../database/connection.js';\nimport logger from '../utils/logger.js';\nimport emailService from './emailService.js';\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY || '', {\n  apiVersion: '2023-10-16',\n});\n\ninterface SubscriptionPlan {\n  id: string;\n  name: string;\n  price: number;\n  currency: string;\n  interval: 'month' | 'year';\n  features: string[];\n}\n\nclass PaymentService {\n  /**\n   * Get available subscription plans\n   */\n  getSubscriptionPlans(): SubscriptionPlan[] {\n    return [\n      {\n        id: 'premium_monthly',\n        name: 'Premium Monthly',\n        price: 999, // $9.99\n        currency: 'usd',\n        interval: 'month',\n        features: [\n          'Advanced coach personality',\n          'Unlimited match analysis',\n          'Priority support',\n          'Advanced analytics',\n          'Custom coaching plans',\n        ],\n      },\n      {\n        id: 'premium_yearly',\n        name: 'Premium Yearly',\n        price: 9999, // $99.99 (save $20)\n        currency: 'usd',\n        interval: 'year',\n        features: [\n          'Advanced coach personality',\n          'Unlimited match analysis',\n          'Priority support',\n          'Advanced analytics',\n          'Custom coaching plans',\n          'Exclusive content',\n        ],\n      },\n      {\n        id: 'pro_monthly',\n        name: 'Pro Monthly',\n        price: 1999, // $19.99\n        currency: 'usd',\n        interval: 'month',\n        features: [\n          'Everything in Premium',\n          'Live coaching sessions',\n          'Tournament access',\n          'Custom reports',\n          'API access',\n        ],\n      },\n    ];\n  }\n\n  /**\n   * Create checkout session\n   */\n  async createCheckoutSession(\n    userId: string,\n    planId: string,\n    successUrl: string,\n    cancelUrl: string\n  ): Promise<string | null> {\n    try {\n      const plan = this.getSubscriptionPlans().find((p) => p.id === planId);\n      if (!plan) {\n        throw new Error('Plan not found');\n      }\n\n      // Get user email\n      const userResult = await db.query('SELECT email FROM users WHERE id = $1', [userId]);\n      if (userResult.rows.length === 0) {\n        throw new Error('User not found');\n      }\n\n      const userEmail = userResult.rows[0].email;\n\n      // Create Stripe session\n      const session = await stripe.checkout.sessions.create({\n        payment_method_types: ['card'],\n        customer_email: userEmail,\n        line_items: [\n          {\n            price_data: {\n              currency: plan.currency,\n              product_data: {\n                name: plan.name,\n                description: `TrixieVerse ${plan.name} Subscription`,\n              },\n              unit_amount: plan.price,\n              recurring: {\n                interval: plan.interval,\n                interval_count: 1,\n              },\n            },\n            quantity: 1,\n          },\n        ],\n        mode: 'subscription',\n        success_url: `${successUrl}?session_id={CHECKOUT_SESSION_ID}`,\n        cancel_url: cancelUrl,\n        metadata: {\n          userId,\n          planId,\n        },\n      });\n\n      logger.info(`Checkout session created for user ${userId}`);\n      return session.url;\n    } catch (error) {\n      logger.error({ message: 'Failed to create checkout session', error });\n      return null;\n    }\n  }\n\n  /**\n   * Handle webhook event\n   */\n  async handleWebhookEvent(event: Stripe.Event): Promise<void> {\n    try {\n      switch (event.type) {\n        case 'checkout.session.completed':\n          await this.handleCheckoutSessionCompleted(event.data.object as Stripe.Checkout.Session);\n          break;\n\n        case 'customer.subscription.updated':\n          await this.handleSubscriptionUpdated(event.data.object as Stripe.Subscription);\n          break;\n\n        case 'customer.subscription.deleted':\n          await this.handleSubscriptionDeleted(event.data.object as Stripe.Subscription);\n          break;\n\n        case 'invoice.payment_succeeded':\n          await this.handleInvoicePaymentSucceeded(event.data.object as Stripe.Invoice);\n          break;\n\n        case 'invoice.payment_failed':\n          await this.handleInvoicePaymentFailed(event.data.object as Stripe.Invoice);\n          break;\n      }\n    } catch (error) {\n      logger.error({ message: 'Failed to handle webhook event', error });\n    }\n  }\n\n  /**\n   * Handle checkout session completed\n   */\n  private async handleCheckoutSessionCompleted(session: Stripe.Checkout.Session): Promise<void> {\n    try {\n      const userId = session.metadata?.userId;\n      const planId = session.metadata?.planId;\n      const subscriptionId = session.subscription as string;\n\n      if (!userId) {\n        throw new Error('User ID not found in session metadata');\n      }\n\n      // Update user subscription\n      await db.query(\n        `UPDATE users SET \n           subscription_plan = $1,\n           stripe_subscription_id = $2,\n           subscription_status = 'active',\n           subscription_started_at = CURRENT_TIMESTAMP\n         WHERE id = $3`,\n        [planId, subscriptionId, userId]\n      );\n\n      // Get user email\n      const userResult = await db.query('SELECT email, username FROM users WHERE id = $1', [userId]);\n      const user = userResult.rows[0];\n\n      // Send confirmation email\n      await emailService.sendEmail({\n        to: user.email,\n        subject: '✅ Subscription Confirmed!',\n        html: `\n          <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n            <div style=\"background: linear-gradient(135deg, #0a0e27 0%, #1e3a8a 100%); padding: 40px; text-align: center; color: #10b981;\">\n              <h1 style=\"margin: 0; font-size: 32px; text-transform: uppercase; letter-spacing: 2px;\">✅ WELCOME TO PREMIUM!</h1>\n            </div>\n            <div style=\"padding: 40px; background: #f5f5f5;\">\n              <p style=\"font-size: 18px; color: #333; margin-bottom: 20px;\">Hey <strong>${user.username}</strong>!</p>\n              <p style=\"font-size: 16px; color: #666; line-height: 1.6; margin-bottom: 20px;\">\n                Your subscription is now active! You now have access to all premium features.\n              </p>\n              <a href=\"${process.env.FRONTEND_URL}/dashboard\" style=\"display: inline-block; margin-top: 30px; padding: 15px 40px; background: #10b981; color: #fff; text-decoration: none; font-weight: bold; text-transform: uppercase; border-radius: 4px; letter-spacing: 1px;\">\n                START COACHING\n              </a>\n            </div>\n          </div>\n        `,\n      });\n\n      logger.info(`Subscription activated for user ${userId}`);\n    } catch (error) {\n      logger.error({ message: 'Failed to handle checkout session completed', error });\n    }\n  }\n\n  /**\n   * Handle subscription updated\n   */\n  private async handleSubscriptionUpdated(subscription: Stripe.Subscription): Promise<void> {\n    try {\n      logger.info(`Subscription updated: ${subscription.id}`);\n    } catch (error) {\n      logger.error({ message: 'Failed to handle subscription updated', error });\n    }\n  }\n\n  /**\n   * Handle subscription deleted\n   */\n  private async handleSubscriptionDeleted(subscription: Stripe.Subscription): Promise<void> {\n    try {\n      // Find user with this subscription\n      const userResult = await db.query(\n        'SELECT id, email FROM users WHERE stripe_subscription_id = $1',\n        [subscription.id]\n      );\n\n      if (userResult.rows.length > 0) {\n        const user = userResult.rows[0];\n\n        // Update user subscription\n        await db.query(\n          `UPDATE users SET \n             subscription_plan = NULL,\n             subscription_status = 'cancelled',\n             subscription_ended_at = CURRENT_TIMESTAMP\n           WHERE id = $1`,\n          [user.id]\n        );\n\n        // Send cancellation email\n        await emailService.sendEmail({\n          to: user.email,\n          subject: 'Subscription Cancelled',\n          html: `\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n              <div style=\"background: linear-gradient(135deg, #0a0e27 0%, #1e3a8a 100%); padding: 40px; text-align: center; color: #ef4444;\">\n                <h1 style=\"margin: 0; font-size: 32px; text-transform: uppercase; letter-spacing: 2px;\">SUBSCRIPTION CANCELLED</h1>\n              </div>\n              <div style=\"padding: 40px; background: #f5f5f5;\">\n                <p style=\"font-size: 16px; color: #666; line-height: 1.6;\">\n                  Your subscription has been cancelled. You still have access to free features.\n                </p>\n                <a href=\"${process.env.FRONTEND_URL}/pricing\" style=\"display: inline-block; margin-top: 30px; padding: 15px 40px; background: #00d4ff; color: #000; text-decoration: none; font-weight: bold; text-transform: uppercase; border-radius: 4px; letter-spacing: 1px;\">\n                  RESUBSCRIBE\n                </a>\n              </div>\n            </div>\n          `,\n        });\n      }\n\n      logger.info(`Subscription cancelled: ${subscription.id}`);\n    } catch (error) {\n      logger.error({ message: 'Failed to handle subscription deleted', error });\n    }\n  }\n\n  /**\n   * Handle invoice payment succeeded\n   */\n  private async handleInvoicePaymentSucceeded(invoice: Stripe.Invoice): Promise<void> {\n    try {\n      logger.info(`Invoice payment succeeded: ${invoice.id}`);\n    } catch (error) {\n      logger.error({ message: 'Failed to handle invoice payment succeeded', error });\n    }\n  }\n\n  /**\n   * Handle invoice payment failed\n   */\n  private async handleInvoicePaymentFailed(invoice: Stripe.Invoice): Promise<void> {\n    try {\n      logger.info(`Invoice payment failed: ${invoice.id}`);\n    } catch (error) {\n      logger.error({ message: 'Failed to handle invoice payment failed', error });\n    }\n  }\n\n  /**\n   * Get user subscription\n   */\n  async getUserSubscription(userId: string): Promise<any | null> {\n    try {\n      const result = await db.query(\n        `SELECT \n           subscription_plan,\n           subscription_status,\n           subscription_started_at,\n           subscription_ended_at\n         FROM users WHERE id = $1`,\n        [userId]\n      );\n\n      return result.rows[0] || null;\n    } catch (error) {\n      logger.error({ message: 'Failed to get user subscription', error });\n      return null;\n    }\n  }\n\n  /**\n   * Cancel subscription\n   */\n  async cancelSubscription(userId: string): Promise<boolean> {\n    try {\n      const userResult = await db.query(\n        'SELECT stripe_subscription_id FROM users WHERE id = $1',\n        [userId]\n      );\n\n      if (userResult.rows.length === 0) {\n        throw new Error('User not found');\n      }\n\n      const subscriptionId = userResult.rows[0].stripe_subscription_id;\n      if (!subscriptionId) {\n        throw new Error('No active subscription');\n      }\n\n      // Cancel Stripe subscription\n      await stripe.subscriptions.del(subscriptionId);\n\n      logger.info(`Subscription cancelled for user ${userId}`);\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to cancel subscription', error });\n      return false;\n    }\n  }\n}\n\nexport default new PaymentService();\n

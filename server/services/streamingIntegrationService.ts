/**\n * Streaming Integration Service\n * Twitch and YouTube integration\n */\n\nimport axios from 'axios';\nimport db from '../database/connection.js';\nimport logger from '../utils/logger.js';\n\ninterface StreamInfo {\n  platform: 'twitch' | 'youtube';\n  username: string;\n  isLive: boolean;\n  viewers?: number;\n  title?: string;\n  game?: string;\n  url?: string;\n}\n\nclass StreamingIntegrationService {\n  private twitchClientId = process.env.TWITCH_CLIENT_ID || '';\n  private twitchAccessToken = process.env.TWITCH_ACCESS_TOKEN || '';\n  private youtubeApiKey = process.env.YOUTUBE_API_KEY || '';\n\n  /**\n   * Get Twitch stream info\n   */\n  async getTwitchStreamInfo(username: string): Promise<StreamInfo | null> {\n    try {\n      // Get user ID\n      const userResponse = await axios.get(`https://api.twitch.tv/helix/users?login=${username}`, {\n        headers: {\n          'Client-ID': this.twitchClientId,\n          Authorization: `Bearer ${this.twitchAccessToken}`,\n        },\n      });\n\n      if (userResponse.data.data.length === 0) {\n        return null;\n      }\n\n      const userId = userResponse.data.data[0].id;\n\n      // Get stream info\n      const streamResponse = await axios.get(`https://api.twitch.tv/helix/streams?user_id=${userId}`, {\n        headers: {\n          'Client-ID': this.twitchClientId,\n          Authorization: `Bearer ${this.twitchAccessToken}`,\n        },\n      });\n\n      if (streamResponse.data.data.length === 0) {\n        return {\n          platform: 'twitch',\n          username,\n          isLive: false,\n        };\n      }\n\n      const stream = streamResponse.data.data[0];\n\n      return {\n        platform: 'twitch',\n        username,\n        isLive: true,\n        viewers: stream.viewer_count,\n        title: stream.title,\n        game: stream.game_name,\n        url: `https://twitch.tv/${username}`,\n      };\n    } catch (error) {\n      logger.error({ message: 'Failed to get Twitch stream info', error });\n      return null;\n    }\n  }\n\n  /**\n   * Get YouTube stream info\n   */\n  async getYouTubeStreamInfo(channelId: string): Promise<StreamInfo | null> {\n    try {\n      const response = await axios.get(\n        `https://www.googleapis.com/youtube/v3/search?key=${this.youtubeApiKey}&channelId=${channelId}&eventType=live&type=video&part=snippet`\n      );\n\n      if (response.data.items.length === 0) {\n        return {\n          platform: 'youtube',\n          username: channelId,\n          isLive: false,\n        };\n      }\n\n      const video = response.data.items[0];\n\n      return {\n        platform: 'youtube',\n        username: channelId,\n        isLive: true,\n        title: video.snippet.title,\n        url: `https://youtube.com/watch?v=${video.id.videoId}`,\n      };\n    } catch (error) {\n      logger.error({ message: 'Failed to get YouTube stream info', error });\n      return null;\n    }\n  }\n\n  /**\n   * Link Twitch account\n   */\n  async linkTwitchAccount(userId: string, twitchUsername: string): Promise<boolean> {\n    try {\n      await db.query(\n        `INSERT INTO streaming_accounts (user_id, platform, username)\n         VALUES ($1, $2, $3)\n         ON CONFLICT (user_id, platform) DO UPDATE SET username = $3`,\n        [userId, 'twitch', twitchUsername]\n      );\n\n      logger.info(`Twitch account linked: ${userId} -> ${twitchUsername}`);\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to link Twitch account', error });\n      return false;\n    }\n  }\n\n  /**\n   * Link YouTube account\n   */\n  async linkYouTubeAccount(userId: string, channelId: string): Promise<boolean> {\n    try {\n      await db.query(\n        `INSERT INTO streaming_accounts (user_id, platform, username)\n         VALUES ($1, $2, $3)\n         ON CONFLICT (user_id, platform) DO UPDATE SET username = $3`,\n        [userId, 'youtube', channelId]\n      );\n\n      logger.info(`YouTube account linked: ${userId} -> ${channelId}`);\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to link YouTube account', error });\n      return false;\n    }\n  }\n\n  /**\n   * Get user's streaming accounts\n   */\n  async getUserStreamingAccounts(userId: string): Promise<StreamInfo[]> {\n    try {\n      const result = await db.query(\n        'SELECT platform, username FROM streaming_accounts WHERE user_id = $1',\n        [userId]\n      );\n\n      const accounts: StreamInfo[] = [];\n\n      for (const row of result.rows) {\n        if (row.platform === 'twitch') {\n          const info = await this.getTwitchStreamInfo(row.username);\n          if (info) accounts.push(info);\n        } else if (row.platform === 'youtube') {\n          const info = await this.getYouTubeStreamInfo(row.username);\n          if (info) accounts.push(info);\n        }\n      }\n\n      return accounts;\n    } catch (error) {\n      logger.error({ message: 'Failed to get user streaming accounts', error });\n      return [];\n    }\n  }\n\n  /**\n   * Get live streamers\n   */\n  async getLiveStreamers(): Promise<StreamInfo[]> {\n    try {\n      const result = await db.query(\n        `SELECT DISTINCT user_id, platform, username FROM streaming_accounts`\n      );\n\n      const liveStreamers: StreamInfo[] = [];\n\n      for (const row of result.rows) {\n        if (row.platform === 'twitch') {\n          const info = await this.getTwitchStreamInfo(row.username);\n          if (info && info.isLive) {\n            liveStreamers.push(info);\n          }\n        } else if (row.platform === 'youtube') {\n          const info = await this.getYouTubeStreamInfo(row.username);\n          if (info && info.isLive) {\n            liveStreamers.push(info);\n          }\n        }\n      }\n\n      return liveStreamers.sort((a, b) => (b.viewers || 0) - (a.viewers || 0));\n    } catch (error) {\n      logger.error({ message: 'Failed to get live streamers', error });\n      return [];\n    }\n  }\n\n  /**\n   * Create stream event\n   */\n  async createStreamEvent(\n    userId: string,\n    title: string,\n    description: string,\n    scheduledTime: Date\n  ): Promise<boolean> {\n    try {\n      await db.query(\n        `INSERT INTO stream_events (user_id, title, description, scheduled_time)\n         VALUES ($1, $2, $3, $4)`,\n        [userId, title, description, scheduledTime]\n      );\n\n      logger.info(`Stream event created: ${userId}`);\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to create stream event', error });\n      return false;\n    }\n  }\n\n  /**\n   * Get upcoming stream events\n   */\n  async getUpcomingStreamEvents(): Promise<any[]> {\n    try {\n      const result = await db.query(\n        `SELECT \n           se.id,\n           se.user_id,\n           u.username,\n           se.title,\n           se.description,\n           se.scheduled_time,\n           sa.platform,\n           sa.username as stream_username\n         FROM stream_events se\n         JOIN users u ON se.user_id = u.id\n         LEFT JOIN streaming_accounts sa ON se.user_id = sa.user_id\n         WHERE se.scheduled_time > NOW()\n         ORDER BY se.scheduled_time ASC\n         LIMIT 20`\n      );\n\n      return result.rows;\n    } catch (error) {\n      logger.error({ message: 'Failed to get upcoming stream events', error });\n      return [];\n    }\n  }\n}\n\nexport default new StreamingIntegrationService();\n

/**\n * Riot Games API Integration Service\n * Fetch real Wild Rift data from Riot API\n */\n\nimport axios, { AxiosInstance } from 'axios';\nimport cache from '../utils/cache';\nimport logger from '../utils/logger';\nimport db from '../database/connection';\n\ninterface PlayerData {\n  puuid: string;\n  gameName: string;\n  tagLine: string;\n  summonerLevel: number;\n}\n\ninterface RankedData {\n  queueType: string;\n  tier: string;\n  rank: string;\n  leaguePoints: number;\n  wins: number;\n  losses: number;\n}\n\ninterface MatchData {\n  metadata: {\n    matchId: string;\n    dataVersion: string;\n    participants: string[];\n    timestamp: number;\n  };\n  info: {\n    gameMode: string;\n    gameDuration: number;\n    gameStartTimestamp: number;\n    participants: any[];\n    teams: any[];\n  };\n}\n\nclass RiotApiIntegrationService {\n  private client: AxiosInstance;\n  private apiKey: string;\n  private baseUrl = 'https://americas.api.riotgames.com';\n  private regionalUrl = 'https://euw1.api.riotgames.com';\n\n  constructor() {\n    this.apiKey = process.env.RIOT_API_KEY || '';\n\n    this.client = axios.create({\n      headers: {\n        'X-Riot-Token': this.apiKey,\n      },\n    });\n  }\n\n  /**\n   * Get player by game name and tag\n   */\n  async getPlayerByName(gameName: string, tagLine: string): Promise<PlayerData | null> {\n    try {\n      const cacheKey = `riot:player:${gameName}:${tagLine}`;\n      const cached = cache.get(cacheKey);\n      if (cached) return cached;\n\n      const response = await this.client.get(\n        `${this.baseUrl}/riot/account/v1/accounts/by-game/${gameName}/${tagLine}`\n      );\n\n      const playerData: PlayerData = {\n        puuid: response.data.puuid,\n        gameName: response.data.gameName,\n        tagLine: response.data.tagLine,\n        summonerLevel: 0,\n      };\n\n      // Cache for 1 hour\n      cache.set(cacheKey, playerData, 3600);\n\n      return playerData;\n    } catch (error) {\n      logger.error({ message: 'Failed to get player by name', error });\n      return null;\n    }\n  }\n\n  /**\n   * Get player summoner data\n   */\n  async getPlayerSummoner(puuid: string): Promise<any | null> {\n    try {\n      const cacheKey = `riot:summoner:${puuid}`;\n      const cached = cache.get(cacheKey);\n      if (cached) return cached;\n\n      const response = await this.client.get(\n        `${this.regionalUrl}/lol/summoner/v4/summoners/by-puuid/${puuid}`\n      );\n\n      const summonerData = {\n        id: response.data.id,\n        accountId: response.data.accountId,\n        puuid: response.data.puuid,\n        name: response.data.name,\n        profileIconId: response.data.profileIconId,\n        summonerLevel: response.data.summonerLevel,\n      };\n\n      // Cache for 24 hours\n      cache.set(cacheKey, summonerData, 86400);\n\n      return summonerData;\n    } catch (error) {\n      logger.error({ message: 'Failed to get player summoner', error });\n      return null;\n    }\n  }\n\n  /**\n   * Get player ranked data\n   */\n  async getPlayerRanked(summonerId: string): Promise<RankedData[] | null> {\n    try {\n      const cacheKey = `riot:ranked:${summonerId}`;\n      const cached = cache.get(cacheKey);\n      if (cached) return cached;\n\n      const response = await this.client.get(\n        `${this.regionalUrl}/lol/league/v4/entries/by-summoner/${summonerId}`\n      );\n\n      const rankedData: RankedData[] = response.data.map((entry: any) => ({\n        queueType: entry.queueType,\n        tier: entry.tier,\n        rank: entry.rank,\n        leaguePoints: entry.leaguePoints,\n        wins: entry.wins,\n        losses: entry.losses,\n      }));\n\n      // Cache for 1 hour\n      cache.set(cacheKey, rankedData, 3600);\n\n      return rankedData;\n    } catch (error) {\n      logger.error({ message: 'Failed to get player ranked data', error });\n      return null;\n    }\n  }\n\n  /**\n   * Get player match history\n   */\n  async getPlayerMatches(puuid: string, start: number = 0, count: number = 20): Promise<string[] | null> {\n    try {\n      const cacheKey = `riot:matches:${puuid}:${start}:${count}`;\n      const cached = cache.get(cacheKey);\n      if (cached) return cached;\n\n      const response = await this.client.get(\n        `${this.baseUrl}/lol/match/v5/matches/by-puuid/${puuid}/ids?start=${start}&count=${count}`\n      );\n\n      // Cache for 30 minutes\n      cache.set(cacheKey, response.data, 1800);\n\n      return response.data;\n    } catch (error) {\n      logger.error({ message: 'Failed to get player matches', error });\n      return null;\n    }\n  }\n\n  /**\n   * Get match details\n   */\n  async getMatchDetails(matchId: string): Promise<MatchData | null> {\n    try {\n      const cacheKey = `riot:match:${matchId}`;\n      const cached = cache.get(cacheKey);\n      if (cached) return cached;\n\n      const response = await this.client.get(\n        `${this.baseUrl}/lol/match/v5/matches/${matchId}`\n      );\n\n      // Cache for 24 hours (matches don't change)\n      cache.set(cacheKey, response.data, 86400);\n\n      return response.data;\n    } catch (error) {\n      logger.error({ message: 'Failed to get match details', error });\n      return null;\n    }\n  }\n\n  /**\n   * Get champion mastery\n   */\n  async getChampionMastery(summonerId: string): Promise<any[] | null> {\n    try {\n      const cacheKey = `riot:mastery:${summonerId}`;\n      const cached = cache.get(cacheKey);\n      if (cached) return cached;\n\n      const response = await this.client.get(\n        `${this.regionalUrl}/lol/champion-mastery/v4/champion-masteries/by-summoner/${summonerId}`\n      );\n\n      const masteryData = response.data.map((entry: any) => ({\n        championId: entry.championId,\n        championLevel: entry.championLevel,\n        championPoints: entry.championPoints,\n        lastPlayTime: entry.lastPlayTime,\n      }));\n\n      // Cache for 1 hour\n      cache.set(cacheKey, masteryData, 3600);\n\n      return masteryData;\n    } catch (error) {\n      logger.error({ message: 'Failed to get champion mastery', error });\n      return null;\n    }\n  }\n\n  /**\n   * Sync player data with database\n   */\n  async syncPlayerData(userId: string, gameName: string, tagLine: string): Promise<boolean> {\n    try {\n      // Get player data\n      const playerData = await this.getPlayerByName(gameName, tagLine);\n      if (!playerData) return false;\n\n      // Get summoner data\n      const summonerData = await this.getPlayerSummoner(playerData.puuid);\n      if (!summonerData) return false;\n\n      // Get ranked data\n      const rankedData = await this.getPlayerRanked(summonerData.id);\n\n      // Get champion mastery\n      const masteryData = await this.getChampionMastery(summonerData.id);\n\n      // Update database\n      await db.query(\n        `UPDATE player_accounts SET \n           riot_puuid = $1,\n           current_rank = $2,\n           last_updated = CURRENT_TIMESTAMP\n         WHERE user_id = $3 AND game_name = $4 AND tag = $5`,\n        [\n          playerData.puuid,\n          rankedData?.[0]?.tier || 'UNRANKED',\n          userId,\n          gameName,\n          tagLine,\n        ]\n      );\n\n      logger.info(`Player data synced for ${gameName}#${tagLine}`);\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to sync player data', error });\n      return false;\n    }\n  }\n\n  /**\n   * Check if API is available\n   */\n  async isAvailable(): Promise<boolean> {\n    try {\n      if (!this.apiKey) {\n        logger.warn('Riot API key not configured');\n        return false;\n      }\n\n      // Test API connection\n      const response = await axios.get('https://status.riotgames.com/api/v1/status', {\n        timeout: 5000,\n      });\n\n      return response.status === 200;\n    } catch (error) {\n      logger.error({ message: 'Riot API not available', error });\n      return false;\n    }\n  }\n}\n\nexport default new RiotApiIntegrationService();\n

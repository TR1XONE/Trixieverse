/**\n * Notification System Service\n * Manages in-app, email, and push notifications\n */\n\nimport db from '../database/connection';\nimport logger from '../utils/logger';\nimport emailService from './emailService.js';\n\ninterface Notification {\n  id?: string;\n  user_id: string;\n  type: 'achievement' | 'rank_up' | 'match_analysis' | 'friend_request' | 'circle_invite' | 'system';\n  title: string;\n  message: string;\n  data?: any;\n  read: boolean;\n  created_at?: string;\n}\n\nclass NotificationSystemService {\n  /**\n   * Create notification\n   */\n  async createNotification(notification: Notification): Promise<string | null> {\n    try {\n      const result = await db.query(\n        `INSERT INTO notifications (user_id, type, title, message, data, read)\n         VALUES ($1, $2, $3, $4, $5, $6)\n         RETURNING id`,\n        [\n          notification.user_id,\n          notification.type,\n          notification.title,\n          notification.message,\n          notification.data ? JSON.stringify(notification.data) : null,\n          notification.read || false,\n        ]\n      );\n\n      const notificationId = result.rows[0].id;\n      logger.info(`Notification created: ${notificationId}`);\n\n      return notificationId;\n    } catch (error) {\n      logger.error({ message: 'Failed to create notification', error });\n      return null;\n    }\n  }\n\n  /**\n   * Get user notifications\n   */\n  async getUserNotifications(userId: string, limit: number = 20): Promise<Notification[]> {\n    try {\n      const result = await db.query(\n        `SELECT * FROM notifications \n         WHERE user_id = $1 \n         ORDER BY created_at DESC \n         LIMIT $2`,\n        [userId, limit]\n      );\n\n      return result.rows.map((row) => ({\n        ...row,\n        data: row.data ? JSON.parse(row.data) : null,\n      }));\n    } catch (error) {\n      logger.error({ message: 'Failed to get user notifications', error });\n      return [];\n    }\n  }\n\n  /**\n   * Get unread notification count\n   */\n  async getUnreadCount(userId: string): Promise<number> {\n    try {\n      const result = await db.query(\n        'SELECT COUNT(*) as count FROM notifications WHERE user_id = $1 AND read = false',\n        [userId]\n      );\n\n      return result.rows[0].count;\n    } catch (error) {\n      logger.error({ message: 'Failed to get unread count', error });\n      return 0;\n    }\n  }\n\n  /**\n   * Mark notification as read\n   */\n  async markAsRead(notificationId: string): Promise<boolean> {\n    try {\n      await db.query('UPDATE notifications SET read = true WHERE id = $1', [notificationId]);\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to mark notification as read', error });\n      return false;\n    }\n  }\n\n  /**\n   * Mark all notifications as read\n   */\n  async markAllAsRead(userId: string): Promise<boolean> {\n    try {\n      await db.query('UPDATE notifications SET read = true WHERE user_id = $1', [userId]);\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to mark all notifications as read', error });\n      return false;\n    }\n  }\n\n  /**\n   * Delete notification\n   */\n  async deleteNotification(notificationId: string): Promise<boolean> {\n    try {\n      await db.query('DELETE FROM notifications WHERE id = $1', [notificationId]);\n      return true;\n    } catch (error) {\n      logger.error({ message: 'Failed to delete notification', error });\n      return false;\n    }\n  }\n\n  /**\n   * Send achievement notification\n   */\n  async notifyAchievementUnlocked(\n    userId: string,\n    achievement: { title: string; description: string; icon: string }\n  ): Promise<void> {\n    try {\n      // Get user email\n      const userResult = await db.query('SELECT email, username FROM users WHERE id = $1', [userId]);\n      if (userResult.rows.length === 0) return;\n\n      const user = userResult.rows[0];\n\n      // Create in-app notification\n      await this.createNotification({\n        user_id: userId,\n        type: 'achievement',\n        title: `üèÜ ${achievement.title}`,\n        message: achievement.description,\n        data: achievement,\n        read: false,\n      });\n\n      // Send email\n      await emailService.sendAchievementEmail(user.email, user.username, achievement.title);\n    } catch (error) {\n      logger.error({ message: 'Failed to notify achievement unlocked', error });\n    }\n  }\n\n  /**\n   * Send rank up notification\n   */\n  async notifyRankUp(userId: string, newRank: string): Promise<void> {\n    try {\n      // Get user email\n      const userResult = await db.query('SELECT email, username FROM users WHERE id = $1', [userId]);\n      if (userResult.rows.length === 0) return;\n\n      const user = userResult.rows[0];\n\n      // Create in-app notification\n      await this.createNotification({\n        user_id: userId,\n        type: 'rank_up',\n        title: `üìà Rank Up!`,\n        message: `Congratulations! You've reached ${newRank}!`,\n        data: { newRank },\n        read: false,\n      });\n\n      // Send email\n      await emailService.sendRankUpEmail(user.email, user.username, newRank);\n    } catch (error) {\n      logger.error({ message: 'Failed to notify rank up', error });\n    }\n  }\n\n  /**\n   * Send match analysis notification\n   */\n  async notifyMatchAnalysis(\n    userId: string,\n    matchStats: { result: string; performance: number; duration: number }\n  ): Promise<void> {\n    try {\n      // Get user email\n      const userResult = await db.query('SELECT email, username FROM users WHERE id = $1', [userId]);\n      if (userResult.rows.length === 0) return;\n\n      const user = userResult.rows[0];\n\n      // Create in-app notification\n      await this.createNotification({\n        user_id: userId,\n        type: 'match_analysis',\n        title: `‚öîÔ∏è Match Analysis`,\n        message: `Your ${matchStats.result} match has been analyzed. Performance: ${matchStats.performance}/100`,\n        data: matchStats,\n        read: false,\n      });\n\n      // Send email\n      await emailService.sendMatchAnalysisEmail(user.email, user.username, matchStats);\n    } catch (error) {\n      logger.error({ message: 'Failed to notify match analysis', error });\n    }\n  }\n\n  /**\n   * Send friend request notification\n   */\n  async notifyFriendRequest(userId: string, friendUsername: string): Promise<void> {\n    try {\n      await this.createNotification({\n        user_id: userId,\n        type: 'friend_request',\n        title: `üë• Friend Request`,\n        message: `${friendUsername} sent you a friend request`,\n        data: { friendUsername },\n        read: false,\n      });\n    } catch (error) {\n      logger.error({ message: 'Failed to notify friend request', error });\n    }\n  }\n\n  /**\n   * Send circle invite notification\n   */\n  async notifyCircleInvite(userId: string, circleName: string, inviterUsername: string): Promise<void> {\n    try {\n      await this.createNotification({\n        user_id: userId,\n        type: 'circle_invite',\n        title: `üéØ Circle Invite`,\n        message: `${inviterUsername} invited you to join \"${circleName}\"`,\n        data: { circleName, inviterUsername },\n        read: false,\n      });\n    } catch (error) {\n      logger.error({ message: 'Failed to notify circle invite', error });\n    }\n  }\n\n  /**\n   * Send system notification\n   */\n  async notifySystem(userId: string, title: string, message: string, data?: any): Promise<void> {\n    try {\n      await this.createNotification({\n        user_id: userId,\n        type: 'system',\n        title,\n        message,\n        data,\n        read: false,\n      });\n    } catch (error) {\n      logger.error({ message: 'Failed to send system notification', error });\n    }\n  }\n\n  /**\n   * Clean up old notifications (older than 30 days)\n   */\n  async cleanupOldNotifications(): Promise<void> {\n    try {\n      const result = await db.query(\n        `DELETE FROM notifications \n         WHERE created_at < NOW() - INTERVAL '30 days'`\n      );\n\n      logger.info(`Cleaned up old notifications: ${result.rowCount} rows deleted`);\n    } catch (error) {\n      logger.error({ message: 'Failed to cleanup old notifications', error });\n    }\n  }\n}\n\nexport default new NotificationSystemService();\n

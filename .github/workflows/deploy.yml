name: Deploy TrixieVerse\n\non:\n  push:\n    branches: [main, develop]\n  pull_request:\n    branches: [main, develop]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n\n    services:\n      postgres:\n        image: postgres:16-alpine\n        env:\n          POSTGRES_DB: trixieverse_test\n          POSTGRES_USER: trixieverse\n          POSTGRES_PASSWORD: test_password\n        options: >-\n          --health-cmd pg_isready\n          --health-interval 10s\n          --health-timeout 5s\n          --health-retries 5\n        ports:\n          - 5432:5432\n\n    steps:\n      - uses: actions/checkout@v3\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v3\n        with:\n          node-version: '22'\n          cache: 'pnpm'\n\n      - name: Install pnpm\n        run: npm install -g pnpm\n\n      - name: Install dependencies\n        run: |\n          cd server && pnpm install\n          cd ../client && pnpm install\n\n      - name: Run tests\n        env:\n          DATABASE_URL: postgresql://trixieverse:test_password@localhost:5432/trixieverse_test\n        run: |\n          cd server && pnpm test\n          cd ../client && pnpm test\n\n      - name: Build\n        run: |\n          cd server && pnpm build\n          cd ../client && pnpm build\n\n  lint:\n    runs-on: ubuntu-latest\n\n    steps:\n      - uses: actions/checkout@v3\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v3\n        with:\n          node-version: '22'\n          cache: 'pnpm'\n\n      - name: Install pnpm\n        run: npm install -g pnpm\n\n      - name: Install dependencies\n        run: |\n          cd server && pnpm install\n          cd ../client && pnpm install\n\n      - name: Lint\n        run: |\n          cd server && pnpm lint\n          cd ../client && pnpm lint\n\n  deploy:\n    needs: [test, lint]\n    runs-on: ubuntu-latest\n    if: github.ref == 'refs/heads/main' && github.event_name == 'push'\n\n    steps:\n      - uses: actions/checkout@v3\n\n      - name: Build Docker image\n        run: docker build -t trixieverse:${{ github.sha }} .\n\n      - name: Push to registry\n        env:\n          REGISTRY_URL: ${{ secrets.REGISTRY_URL }}\n          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}\n          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}\n        run: |\n          echo $REGISTRY_PASSWORD | docker login -u $REGISTRY_USERNAME --password-stdin $REGISTRY_URL\n          docker tag trixieverse:${{ github.sha }} $REGISTRY_URL/trixieverse:latest\n          docker push $REGISTRY_URL/trixieverse:latest\n\n      - name: Deploy to production\n        env:\n          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}\n          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}\n          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}\n        run: |\n          mkdir -p ~/.ssh\n          echo \"$DEPLOY_KEY\" > ~/.ssh/deploy_key\n          chmod 600 ~/.ssh/deploy_key\n          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST 'cd /app && docker pull ${{ secrets.REGISTRY_URL }}/trixieverse:latest && docker-compose up -d'\n
